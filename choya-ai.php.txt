<?php
/**
 * Plugin Name: Choya AI - Free AI Chat Assistant
 * Plugin URI: https://choya.ai
 * Description: Professional AI chat assistant with OpenRouter integration. Free version with basic features.
 * Version: 1.0.0
 * Author: Choya AI Team
 * Author URI: https://choya.ai
 * License: GPL v3.0
 * License URI: https://www.gnu.org/licenses/gpl-3.0.html
 * Text Domain: choya-ai
 * Domain Path: /languages
 * Requires PHP: 7.4
 * Requires at least: 5.8
 * 
 * @package Choya_AI
 * @author Choya AI Team
 * @copyright 2024 Choya AI
 * @license GPL v3.0
 */

// Exit if accessed directly
if (!defined('ABSPATH')) {
    exit;
}

// Plugin Constants
define('CHOYA_AI_VERSION', '1.0.0');
define('CHOYA_AI_PLUGIN_DIR', plugin_dir_path(__FILE__));
define('CHOYA_AI_PLUGIN_URL', plugin_dir_url(__FILE__));
define('CHOYA_AI_BASENAME', plugin_basename(__FILE__));

/**
 * Main Choya AI Plugin Class
 */
final class Choya_AI {
    
    /**
     * Plugin instance
     * 
     * @var Choya_AI
     */
    private static $instance;
    
    /**
     * Plugin constructor
     */
    private function __construct() {
        $this->load_dependencies();
        $this->define_hooks();
        $this->load_textdomain();
    }
    
    /**
     * Get plugin instance
     * 
     * @return Choya_AI
     */
    public static function get_instance() {
        if (null === self::$instance) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    /**
     * Load required dependencies
     */
    private function load_dependencies() {
        // Load admin functionality
        if (is_admin()) {
            require_once CHOYA_AI_PLUGIN_DIR . 'includes/class-choya-admin.php';
        }
        
        // Load shortcode functionality
        require_once CHOYA_AI_PLUGIN_DIR . 'includes/class-choya-shortcode.php';
        
        // Load API functionality
        require_once CHOYA_AI_PLUGIN_DIR . 'includes/class-choya-api.php';
        
        // Load frontend functionality
        require_once CHOYA_AI_PLUGIN_DIR . 'includes/class-choya-frontend.php';
        
        // Load Pro features (will check license)
        require_once CHOYA_AI_PLUGIN_DIR . 'includes/class-choya-pro-features.php';
        
        // Load analytics
        require_once CHOYA_AI_PLUGIN_DIR . 'includes/class-choya-analytics.php';
    }
    
    /**
     * Define WordPress hooks
     */
    private function define_hooks() {
        // Activation and deactivation hooks
        register_activation_hook(__FILE__, array($this, 'activate'));
        register_deactivation_hook(__FILE__, array($this, 'deactivate'));
        
        // Admin hooks
        add_action('admin_init', array($this, 'admin_init'));
        add_action('admin_menu', array($this, 'admin_menu'));
        add_action('admin_enqueue_scripts', array($this, 'admin_scripts'));
        
        // Frontend hooks
        add_action('wp_enqueue_scripts', array($this, 'frontend_scripts'));
        add_action('wp_footer', array($this, 'render_chat_widget'));
        
        // AJAX hooks
        add_action('wp_ajax_choya_chat', array($this, 'handle_chat_request'));
        add_action('wp_ajax_nopriv_choya_chat', array($this, 'handle_chat_request'));
        add_action('wp_ajax_choya_activate_license', array($this, 'activate_license'));
        add_action('wp_ajax_choya_deactivate_license', array($this, 'deactivate_license'));
        
        // Shortcode
        add_shortcode('choya_ai_chat', array($this, 'chat_shortcode'));
        
        // Admin notices
        add_action('admin_notices', array($this, 'check_requirements'));
    }
    
    /**
     * Initialize admin functionality
     */
    public function admin_init() {
        // Load admin class
        if (is_admin()) {
            new Choya_AI_Admin();
        }
        
        // Initialize Pro features
        new Choya_AI_Pro_Features();
        
        // Initialize analytics
        new Choya_AI_Analytics();
    }
    
    /**
     * Plugin activation
     */
    public function activate() {
        // Create necessary database tables
        $this->create_tables();
        
        // Set default options
        $this->set_defaults();
        
        // Flush rewrite rules
        flush_rewrite_rules();
    }
    
    /**
     * Plugin deactivation
     */
    public function deactivate() {
        // Clean up scheduled events
        wp_clear_scheduled_hook('choya_ai_hourly_event');
    }
    
    /**
     * Create database tables
     */
    private function create_tables() {
        global $wpdb;
        
        $table_name = $wpdb->prefix . 'choya_ai_conversations';
        $charset_collate = $wpdb->get_charset_collate();
        
        $sql = "CREATE TABLE $table_name (
            id mediumint(9) NOT NULL AUTO_INCREMENT,
            user_id bigint(20) DEFAULT 0,
            session_id varchar(255) DEFAULT '',
            message text NOT NULL,
            sender varchar(20) NOT NULL,
            timestamp datetime DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            INDEX user_idx (user_id),
            INDEX session_idx (session_id)
        ) $charset_collate;";
        
        require_once ABSPATH . 'wp-admin/includes/upgrade.php';
        dbDelta($sql);
    }
    
    /**
     * Set default options
     */
    private function set_defaults() {
        $defaults = array(
            'enable_chat' => '1',
            'chat_position' => 'bottom-right',
            'brand_name' => 'Choya AI',
            'welcome_message' => 'Hi! I\'m Choya, your AI assistant. How can I help you today?',
            'enable_context' => '1',
            'max_tokens' => 500,
            'temperature' => 0.7,
            'is_pro' => '0',
            'license_key' => '',
            'license_status' => 'inactive'
        );
        
        foreach ($defaults as $key => $value) {
            if (get_option('choya_ai_' . $key) === false) {
                update_option('choya_ai_' . $key, $value);
            }
        }
    }
    
    /**
     * Admin menu
     */
    public function admin_menu() {
        add_menu_page(
            __('Choya AI Settings', 'choya-ai'),
            'Choya AI',
            'manage_options',
            'choya-ai-settings',
            array($this, 'render_admin_page'),
            'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJaTTEyIDE4Yy0yLjIgMC00LTEuOC00LTRzMS44LTQgNC00IDQgMS44IDQgNFMxNC4yIDE4IDEyIDE4WiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTExIDEwbDEgNmg0bC0xLTZoLTROMSAxMFoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',
            55
        );
    }
    
    /**
     * Render admin page
     */
    public function render_admin_page() {
        $active_tab = isset($_GET['tab']) ? sanitize_text_field($_GET['tab']) : 'general';
        
        echo '<div class="wrap">';
        echo '<h1>ü§ñ Choya AI Assistant</h1>';
        
        // Tab navigation
        echo '<nav class="nav-tab-wrapper">';
        echo '<a href="?page=choya-ai-settings&tab=general" class="nav-tab ' . ($active_tab === 'general' ? 'nav-tab-active' : '') . '">‚öôÔ∏è General</a>';
        echo '<a href="?page=choya-ai-settings&tab=pro" class="nav-tab ' . ($active_tab === 'pro' ? 'nav-tab-active' : '') . '">üöÄ Pro Version</a>';
        echo '<a href="?page=choya-ai-settings&tab=analytics" class="nav-tab ' . ($active_tab === 'analytics' ? 'nav-tab-active' : '') . '">üìä Analytics</a>';
        echo '</nav>';
        
        // Tab content
        switch ($active_tab) {
            case 'pro':
                $this->render_pro_tab();
                break;
            case 'analytics':
                $this->render_analytics_tab();
                break;
            default:
                $this->render_general_tab();
                break;
        }
        
        echo '</div>';
    }
    
    /**
     * Render general settings tab
     */
    private function render_general_tab() {
        if (isset($_POST['submit'])) {
            $this->save_general_settings();
        }
        
        $settings = $this->get_general_settings();
        
        echo '<form method="post" style="max-width: 800px;">';
        echo '<table class="form-table">';
        echo '<tr><th colspan="2"><h3>üîß Basic Settings</h3></th></tr>';
        
        echo '<tr>';
        echo '<th scope="row">Enable Chat Widget</th>';
        echo '<td><input type="checkbox" name="enable_chat" ' . checked($settings['enable_chat'], '1', false) . '> <strong>Enable the chat widget on your site</strong></td>';
        echo '</tr>';
        
        echo '<tr>';
        echo '<th scope="row">Chat Position</th>';
        echo '<td><select name="chat_position">';
        $positions = array('bottom-right' => 'Bottom Right', 'bottom-left' => 'Bottom Left', 'top-right' => 'Top Right', 'top-left' => 'Top Left');
        foreach ($positions as $value => $label) {
            echo '<option value="' . $value . '" ' . selected($settings['chat_position'], $value, false) . '>' . $label . '</option>';
        }
        echo '</select></td>';
        echo '</tr>';
        
        echo '<tr>';
        echo '<th scope="row">Assistant Name</th>';
        echo '<td><input type="text" name="brand_name" value="' . esc_attr($settings['brand_name']) . '" style="width: 300px;"></td>';
        echo '</tr>';
        
        echo '<tr>';
        echo '<th scope="row">Welcome Message</th>';
        echo '<td><textarea name="welcome_message" rows="3" style="width: 300px;">' . esc_textarea($settings['welcome_message']) . '</textarea></td>';
        echo '</tr>';
        
        echo '<tr><th colspan="2"><h3>üîå AI Configuration</h3></th></tr>';
        
        echo '<tr>';
        echo '<th scope="row">OpenRouter API Key</th>';
        echo '<td><input type="password" name="openrouter_api_key" value="' . esc_attr(get_option('choya_ai_openrouter_api_key', '')) . '" style="width: 300px;" placeholder="sk-or-v1-...">';
        echo '<p class="description">Get your API key from <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a></p></td>';
        echo '</tr>';
        
        echo '<tr>';
        echo '<th scope="row">AI Model</th>';
        echo '<td><select name="openrouter_model" style="width: 300px;">';
        $models = array(
            'anthropic/claude-3-sonnet' => 'Anthropic Claude 3 Sonnet (Best for conversations)',
            'openai/gpt-4o' => 'OpenAI GPT-4o (Advanced reasoning)',
            'google/gemini-pro' => 'Google Gemini Pro (Balanced)',
            'anthropic/claude-3-haiku' => 'Anthropic Claude 3 Haiku (Fast & affordable)'
        );
        foreach ($models as $value => $label) {
            echo '<option value="' . $value . '" ' . selected(get_option('choya_ai_openrouter_model', 'anthropic/claude-3-sonnet'), $value, false) . '>' . $label . '</option>';
        }
        echo '</select></td>';
        echo '</tr>';
        
        echo '</table>';
        echo '<p class="submit"><input type="submit" name="submit" class="button-primary" value="üíæ Save Settings"></p>';
        echo '</form>';
    }
    
    /**
     * Render Pro version tab
     */
    private function render_pro_tab() {
        $is_pro = get_option('choya_ai_is_pro', '0');
        $license_status = get_option('choya_ai_license_status', 'inactive');
        
        echo '<div style="max-width: 800px;">';
        
        if ($is_pro === '1' && $license_status === 'active') {
            echo '<div class="notice notice-success is-dismissible">';
            echo '<p><strong>üéâ You have Choya AI Pro!</strong> Your license is active and all premium features are available.</p>';
            echo '</div>';
            
            // Show Pro features
            $this->render_pro_features();
            
        } else {
            echo '<div class="notice notice-info is-dismissible">';
            echo '<p><strong>üöÄ Upgrade to Choya AI Pro</strong> to unlock powerful features like smart triggers, analytics, multi-language support, and more!</p>';
            echo '</div>';
            
            // License activation form
            echo '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">';
            echo '<h3>üîë Activate Pro License</h3>';
            
            if ($license_status === 'expired') {
                echo '<div class="notice notice-warning is-dismissible">';
                echo '<p><strong>Your license has expired!</strong> Please renew to continue using Pro features.</p>';
                echo '</div>';
            }
            
            echo '<form method="post" id="choya-license-form">';
            echo '<table class="form-table">';
            echo '<tr>';
            echo '<th scope="row">Your Email</th>';
            echo '<td><input type="email" name="license_email" style="width: 300px;" required placeholder="your@email.com"></td>';
            echo '</tr>';
            echo '<tr>';
            echo '<th scope="row">License Key</th>';
            echo '<td><input type="text" name="license_key" style="width: 300px;" required placeholder="XXXX-XXXX-XXXX-XXXX">';
            echo '<p class="description">Get your license key after purchasing from <a href="https://choya.ai/pricing" target="_blank">choya.ai/pricing</a></p></td>';
            echo '</tr>';
            echo '</table>';
            echo '<p><input type="submit" name="activate_license" class="button-primary" value="üöÄ Activate Pro Version">';
            echo ' <a href="https://choya.ai/pricing" target="_blank" class="button">üí≥ Buy License</a></p>';
            echo '</form>';
            echo '</div>';
            
            // Pro features comparison
            $this->render_pro_features_comparison();
        }
        
        echo '</div>';
    }
    
    /**
     * Render Pro features comparison
     */
    private function render_pro_features_comparison() {
        echo '<div style="margin-top: 30px;">';
        echo '<h3>‚ú® What You Get with Choya AI Pro</h3>';
        
        $pro_features = array(
            'Smart Context Learning' => 'AI learns from your content and user behavior',
            'Multi-Language Support' => 'Real-time translation and language detection',
            'Advanced Analytics' => 'Conversation analytics and conversion tracking',
            'Smart Triggers' => 'Behavioral and time-based chat triggers',
            'E-Commerce Integration' => 'Product recommendations and order tracking',
            'Content Enhancement' => 'Quiz generation and content summarization',
            'Voice & Multimedia' => 'Voice chat and image analysis',
            'Team Collaboration' => 'Multiple AI personas and human handoff',
            'Advanced Customization' => 'Brand customization and custom prompts',
            'Integrations Ecosystem' => 'CRM, Helpdesk, and Marketing integrations',
            'Lead Generation' => 'Smart lead capture and qualification',
            'Content Marketing' => 'SEO suggestions and content gap analysis',
            'Accessibility Features' => 'Screen reader and keyboard navigation',
            'White Label Solution' => 'Remove branding and custom domain',
            'Industry Templates' => 'E-commerce, Education, Real Estate AI',
            'Gamification' => 'Progress tracking and achievement badges',
            'Proactive Assistance' => 'Predictive help and feature announcements'
        );
        
        echo '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">';
        foreach ($pro_features as $feature => $description) {
            echo '<div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            echo '<h4>‚úÖ ' . $feature . '</h4>';
            echo '<p style="color: #666; margin: 0;">' . $description . '</p>';
            echo '</div>';
        }
        echo '</div>';
        
        echo '<div style="text-align: center; margin-top: 30px;">';
        echo '<a href="https://choya.ai/pricing" target="_blank" class="button button-primary" style="padding: 15px 30px; font-size: 16px; background: #4a90e2;">';
        echo 'üöÄ Get Choya AI Pro - Start Free Trial';
        echo '</a>';
        echo '</div>';
        echo '</div>';
    }
    
    /**
     * Render Pro features (when licensed)
     */
    private function render_pro_features() {
        echo '<h3>üéØ Your Pro Features</h3>';
        echo '<p>All premium features are now active! Configure them below:</p>';
        
        echo '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">';
        
        echo '<div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #4a90e2; box-shadow: 0 2px 4px rgba(74,144,226,0.2);">';
        echo '<h4>üìä Analytics Dashboard</h4>';
        echo '<p>View conversation analytics, user behavior, and conversion tracking.</p>';
        echo '<a href="#" class="button">View Analytics</a>';
        echo '</div>';
        
        echo '<div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #4a90e2; box-shadow: 0 2px 4px rgba(74,144,226,0.2);">';
        echo '<h4>üéØ Smart Triggers</h4>';
        echo '<p>Set up behavioral triggers and automated chat responses.</p>';
        echo '<a href="#" class="button">Configure Triggers</a>';
        echo '</div>';
        
        echo '<div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #4a90e2; box-shadow: 0 2px 4px rgba(74,144,226,0.2);">';
        echo '<h4>üåç Multi-Language</h4>';
        echo '<p>Enable translations and language detection for global users.</p>';
        echo '<a href="#" class="button">Setup Languages</a>';
        echo '</div>';
        
        echo '</div>';
    }
    
    /**
     * Render analytics tab
     */
    private function render_analytics_tab() {
        echo '<div style="max-width: 1200px;">';
        echo '<h3>üìä Choya AI Analytics</h3>';
        
        // Get analytics data
        $analytics = $this->get_analytics_data();
        
        echo '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">';
        
        echo '<div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
        echo '<h2>' . $analytics['total_chats'] . '</h2>';
        echo '<p style="color: #666; margin: 0;">Total Conversations</p>';
        echo '</div>';
        
        echo '<div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
        echo '<h2>' . $analytics['avg_response_time'] . 's</h2>';
        echo '<p style="color: #666; margin: 0;">Average Response Time</p>';
        echo '</div>';
        
        echo '<div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
        echo '<h2>' . $analytics['satisfaction_rate'] . '%</h2>';
        echo '<p style="color: #666; margin: 0;">User Satisfaction</p>';
        echo '</div>';
        
        echo '<div style="background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
        echo '<h2>' . $analytics['conversion_rate'] . '%</h2>';
        echo '<p style="color: #666; margin: 0;">Conversion Rate</p>';
        echo '</div>';
        
        echo '</div>';
        
        echo '<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
        echo '<h4>üìà Recent Activity</h4>';
        echo '<p>This feature requires Choya AI Pro for full functionality.</p>';
        echo '<a href="?page=choya-ai-settings&tab=pro" class="button">Upgrade to Pro</a>';
        echo '</div>';
        
        echo '</div>';
    }
    
    /**
     * Get analytics data
     */
    private function get_analytics_data() {
        global $wpdb;
        
        $table_name = $wpdb->prefix . 'choya_ai_conversations';
        
        $total_chats = $wpdb->get_var("SELECT COUNT(DISTINCT session_id) FROM $table_name WHERE DATE(timestamp) = CURDATE()");
        $avg_response_time = rand(2, 5); // Mock data for demo
        $satisfaction_rate = rand(85, 95); // Mock data for demo
        $conversion_rate = rand(15, 25); // Mock data for demo
        
        return array(
            'total_chats' => $total_chats ?: 0,
            'avg_response_time' => $avg_response_time,
            'satisfaction_rate' => $satisfaction_rate,
            'conversion_rate' => $conversion_rate
        );
    }
    
    /**
     * Save general settings
     */
    private function save_general_settings() {
        if (!current_user_can('manage_options')) {
            return;
        }
        
        check_admin_referer('choya_ai_settings');
        
        $settings = array(
            'enable_chat' => isset($_POST['enable_chat']) ? '1' : '0',
            'chat_position' => sanitize_text_field($_POST['chat_position']),
            'brand_name' => sanitize_text_field($_POST['brand_name']),
            'welcome_message' => sanitize_textarea_field($_POST['welcome_message'])
        );
        
        foreach ($settings as $key => $value) {
            update_option('choya_ai_' . $key, $value);
        }
        
        if (isset($_POST['openrouter_api_key'])) {
            update_option('choya_ai_openrouter_api_key', sanitize_text_field($_POST['openrouter_api_key']));
        }
        
        if (isset($_POST['openrouter_model'])) {
            update_option('choya_ai_openrouter_model', sanitize_text_field($_POST['openrouter_model']));
        }
        
        echo '<div class="notice notice-success is-dismissible"><p>‚úÖ Settings saved successfully!</p></div>';
    }
    
    /**
     * Get general settings
     */
    private function get_general_settings() {
        return array(
            'enable_chat' => get_option('choya_ai_enable_chat', '1'),
            'chat_position' => get_option('choya_ai_chat_position', 'bottom-right'),
            'brand_name' => get_option('choya_ai_brand_name', 'Choya AI'),
            'welcome_message' => get_option('choya_ai_welcome_message', 'Hi! I\'m Choya, your AI assistant. How can I help you today?')
        );
    }
    
    /**
     * Load text domain
     */
    private function load_textdomain() {
        load_plugin_textdomain(
            'choya-ai',
            false,
            dirname(plugin_basename(__FILE__)) . '/languages/'
        );
    }
    
    /**
     * Check requirements and show admin notices
     */
    public function check_requirements() {
        // Check PHP version
        if (version_compare(PHP_VERSION, '7.4', '<')) {
            echo '<div class="notice notice-error is-dismissible">';
            echo '<p><strong>Choya AI requires PHP 7.4 or higher.</strong> You are running PHP ' . PHP_VERSION . '</p>';
            echo '</div>';
            return;
        }
        
        // Check OpenRouter API key
        $api_key = get_option('choya_ai_openrouter_api_key');
        if (empty($api_key)) {
            echo '<div class="notice notice-warning is-dismissible">';
            echo '<p><strong>ü§ñ Choya AI:</strong> Please configure your OpenRouter API key in <a href="' . admin_url('admin.php?page=choya-ai-settings') . '">settings</a> to enable AI responses.</p>';
            echo '</div>';
        }
    }
    
    /**
     * Admin scripts
     */
    public function admin_scripts($hook) {
        if ($hook !== 'toplevel_page_choya-ai-settings') {
            return;
        }
        
        wp_enqueue_style('choya-ai-admin', CHOYA_AI_PLUGIN_URL . 'assets/css/choya-admin.css', array(), CHOYA_AI_VERSION);
        wp_enqueue_script('choya-ai-admin', CHOYA_AI_PLUGIN_URL . 'assets/js/choya-admin.js', array('jquery'), CHOYA_AI_VERSION, true);
        
        wp_localize_script('choya-ai-admin', 'choya_admin_ajax', array(
            'ajax_url' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('choya_admin_nonce')
        ));
    }
    
    /**
     * Frontend scripts
     */
    public function frontend_scripts() {
        if ($this->is_chat_enabled()) {
            wp_enqueue_style('choya-ai', CHOYA_AI_PLUGIN_URL . 'assets/css/choya-ai.css', array(), CHOYA_AI_VERSION);
            wp_enqueue_script('choya-ai', CHOYA_AI_PLUGIN_URL . 'assets/js/choya-ai.js', array('jquery'), CHOYA_AI_VERSION, true);
            
            wp_localize_script('choya-ai', 'choya_frontend', array(
                'ajax_url' => admin_url('admin-ajax.php'),
                'nonce' => wp_create_nonce('choya_frontend_nonce'),
                'settings' => $this->get_chat_settings(),
                'is_pro' => get_option('choya_ai_is_pro', '0')
            ));
        }
    }
    
    /**
     * Check if chat is enabled
     */
    private function is_chat_enabled() {
        return get_option('choya_ai_enable_chat', '1') === '1';
    }
    
    /**
     * Get chat settings
     */
    private function get_chat_settings() {
        return array(
            'brand_name' => get_option('choya_ai_brand_name', 'Choya AI'),
            'welcome_message' => get_option('choya_ai_welcome_message', 'Hi! I\'m Choya, your AI assistant. How can I help you today?'),
            'chat_position' => get_option('choya_ai_chat_position', 'bottom-right')
        );
    }
    
    /**
     * Render chat widget
     */
    public function render_chat_widget() {
        if (!$this->is_chat_enabled()) {
            return;
        }
        
        $settings = $this->get_chat_settings();
        $is_pro = get_option('choya_ai_is_pro', '0') === '1';
        
        include CHOYA_AI_PLUGIN_DIR . 'templates/chat-widget.php';
    }
    
    /**
     * Chat shortcode
     */
    public function chat_shortcode($atts) {
        $atts = shortcode_atts(array(
            'position' => 'center',
            'width' => '100%',
            'height' => '500px',
            'embedded' => 'false'
        ), $atts, 'choya_ai_chat');
        
        ob_start();
        
        echo '<div class="choya-ai-embedded" style="width: ' . esc_attr($atts['width']) . '; height: ' . esc_attr($atts['height']) . ';">';
        echo '<div class="choya-ai-embedded-header">';
        echo '<div class="choya-ai-embedded-avatar">ü§ñ</div>';
        echo '<div class="choya-ai-embedded-title">' . esc_html(get_option('choya_ai_brand_name', 'Choya AI')) . '</div>';
        echo '</div>';
        echo '<div class="choya-ai-embedded-messages" id="choya-embedded-messages">';
        echo '<div class="choya-ai-message choya-ai-bot">';
        echo '<div class="choya-ai-avatar-small">ü§ñ</div>';
        echo '<div class="choya-ai-bubble">';
        echo '<div class="choya-ai-text">' . esc_html(get_option('choya_ai_welcome_message', 'Hi! I\'m Choya, your AI assistant. How can I help you today?')) . '</div>';
        echo '</div>';
        echo '</div>';
        echo '</div>';
        echo '<div class="choya-ai-embedded-input">';
        echo '<input type="text" id="choya-embedded-input" placeholder="Type your message..." maxlength="500">';
        echo '<button id="choya-embedded-send" disabled>‚û§</button>';
        echo '</div>';
        echo '</div>';
        
        return ob_get_clean();
    }
    
    /**
     * Handle chat request
     */
    public function handle_chat_request() {
        check_ajax_referer('choya_frontend_nonce', 'nonce');
        
        $user_message = sanitize_text_field($_POST['message']);
        $conversation_history = isset($_POST['history']) ? json_decode(stripslashes($_POST['history']), true) : array();
        $session_id = !empty($_POST['session_id']) ? sanitize_text_field($_POST['session_id']) : wp_generate_password(12, false);
        
        // Save conversation to database
        $this->save_conversation($session_id, $user_message, 'user');
        
        // Get AI response
        $response = $this->get_ai_response($user_message, $conversation_history);
        
        if ($response['success']) {
            $this->save_conversation($session_id, $response['message'], 'bot');
            
            wp_send_json_success(array(
                'response' => $response['message'],
                'session_id' => $session_id
            ));
        } else {
            wp_send_json_error(array(
                'message' => $response['error'],
                'session_id' => $session_id
            ));
        }
    }
    
    /**
     * Save conversation to database
     */
    private function save_conversation($session_id, $message, $sender) {
        global $wpdb;
        
        $table_name = $wpdb->prefix . 'choya_ai_conversations';
        
        $wpdb->insert(
            $table_name,
            array(
                'user_id' => get_current_user_id(),
                'session_id' => $session_id,
                'message' => $message,
                'sender' => $sender
            ),
            array('%d', '%s', '%s', '%s')
        );
    }
    
    /**
     * Get AI response from OpenRouter
     */
    private function get_ai_response($user_message, $conversation_history) {
        $api_key = get_option('choya_ai_openrouter_api_key');
        
        if (empty($api_key)) {
            return array(
                'success' => false,
                'error' => 'OpenRouter API key not configured. Please contact the site administrator.'
            );
        }
        
        // Prepare conversation history
        $messages = array();
        
        // Add system message
        $system_message = "You are Choya, a helpful AI assistant. Your goal is to assist users with their questions and provide informative, engaging responses. Be friendly and professional.";
        
        // Add page context if available
        if (get_option('choya_ai_enable_context', '1') === '1') {
            $page_context = $this->get_page_context();
            if (!empty($page_context)) {
                $system_message .= "\n\nCurrent page context: " . $page_context;
            }
        }
        
        $messages[] = array('role' => 'system', 'content' => $system_message);
        
        // Add conversation history
        foreach ($conversation_history as $message) {
            $messages[] = array(
                'role' => $message['sender'] == 'user' ? 'user' : 'assistant',
                'content' => $message['message']
            );
        }
        
        // Add current user message
        $messages[] = array('role' => 'user', 'content' => $user_message);
        
        // Prepare API request
        $model = get_option('choya_ai_openrouter_model', 'anthropic/claude-3-sonnet');
        $max_tokens = get_option('choya_ai_max_tokens', 500);
        $temperature = get_option('choya_ai_temperature', 0.7);
        
        $api_data = array(
            'model' => $model,
            'messages' => $messages,
            'max_tokens' => $max_tokens,
            'temperature' => $temperature,
            'stream' => false
        );
        
        // Make API request
        $response = wp_remote_post('https://openrouter.ai/api/v1/chat/completions', array(
            'headers' => array(
                'Content-Type' => 'application/json',
                'Authorization' => 'Bearer ' . $api_key,
                'HTTP-Referer' => get_site_url(),
                'X-Title' => get_bloginfo('name')
            ),
            'body' => json_encode($api_data),
            'timeout' => 30,
            'sslverify' => true
        ));
        
        if (is_wp_error($response)) {
            return array(
                'success' => false,
                'error' => 'Failed to connect to OpenRouter API: ' . $response->get_error_message()
            );
        }
        
        $response_code = wp_remote_retrieve_response_code($response);
        $response_body = wp_remote_retrieve_body($response);
        
        if ($response_code !== 200) {
            return array(
                'success' => false,
                'error' => 'OpenRouter API error: HTTP ' . $response_code
            );
        }
        
        $data = json_decode($response_body, true);
        
        if (isset($data['choices'][0]['message']['content'])) {
            return array(
                'success' => true,
                'message' => $data['choices'][0]['message']['content']
            );
        } else {
            return array(
                'success' => false,
                'error' => 'Invalid response from OpenRouter API'
            );
        }
    }
    
    /**
     * Get page context
     */
    private function get_page_context() {
        $context = '';
        
        if (is_single() || is_page()) {
            global $post;
            if ($post) {
                $content = wp_strip_all_tags($post->post_content);
                $content = substr($content, 0, 300);
                $context .= "Page content: " . $content . ". ";
                $context .= "Page title: " . $post->post_title . ". ";
            }
        } elseif (is_home()) {
            $context = "This is the homepage.";
        }
        
        return trim($context);
    }
    
    /**
     * Activate license
     */
    public function activate_license() {
        check_ajax_referer('choya_admin_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_send_json_error(array('message' => 'Unauthorized'));
        }
        
        $email = sanitize_email($_POST['license_email']);
        $license_key = sanitize_text_field($_POST['license_key']);
        
        if (empty($email) || empty($license_key)) {
            wp_send_json_error(array('message' => 'Please provide both email and license key'));
        }
        
        // Validate license with remote server
        $validation_result = $this->validate_license_remote($email, $license_key);
        
        if ($validation_result['success']) {
            update_option('choya_ai_is_pro', '1');
            update_option('choya_ai_license_key', $license_key);
            update_option('choya_ai_license_email', $email);
            update_option('choya_ai_license_status', 'active');
            update_option('choya_ai_license_expiry', $validation_result['expiry_date']);
            update_option('choya_ai_license_activated', current_time('mysql'));
            
            wp_send_json_success(array('message' => 'üéâ Pro license activated successfully!'));
        } else {
            wp_send_json_error(array('message' => $validation_result['error']));
        }
    }
    
    /**
     * Deactivate license
     */
    public function deactivate_license() {
        check_ajax_referer('choya_admin_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_send_json_error(array('message' => 'Unauthorized'));
        }
        
        update_option('choya_ai_is_pro', '0');
        update_option('choya_ai_license_key', '');
        update_option('choya_ai_license_email', '');
        update_option('choya_ai_license_status', 'inactive');
        update_option('choya_ai_license_expiry', '');
        
        wp_send_json_success(array('message' => 'License deactivated'));
    }
    
    /**
     * Validate license with remote server
     */
    private function validate_license_remote($email, $license_key) {
        // This would connect to your licensing server
        // For demo purposes, we'll simulate validation
        
        $api_url = 'https://choya.ai/api/v1/validate-license';
        
        $response = wp_remote_post($api_url, array(
            'body' => array(
                'email' => $email,
                'license_key' => $license_key,
                'domain' => get_site_url(),
                'version' => CHOYA_AI_VERSION
            ),
            'timeout' => 15
        ));
        
        if (is_wp_error($response)) {
            return array(
                'success' => false,
                'error' => 'Could not connect to licensing server: ' . $response->get_error_message()
            );
        }
        
        $response_code = wp_remote_retrieve_response_code($response);
        $response_body = wp_remote_retrieve_body($response);
        
        if ($response_code === 200) {
            $data = json_decode($response_body, true);
            if ($data['valid']) {
                return array(
                    'success' => true,
                    'expiry_date' => $data['expiry_date']
                );
            } else {
                return array(
                    'success' => false,
                    'error' => $data['error'] ?: 'Invalid license key'
                );
            }
        }
        
        return array(
            'success' => false,
            'error' => 'License validation service unavailable'
        );
    }
}

/**
 * Initialize the plugin
 */
function choya_ai_init() {
    return Choya_AI::get_instance();
}

// Run the plugin
choya_ai_init();