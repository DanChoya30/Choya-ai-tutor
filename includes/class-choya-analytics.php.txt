<?php
/**
 * Choya AI Analytics
 */

if (!defined('ABSPATH')) {
    exit;
}

class Choya_AI_Analytics {
    
    public function __construct() {
        add_action('choya_ai_hourly_event', array($this, 'generate_analytics_report'));
        
        if (is_admin()) {
            add_action('wp_ajax_choya_export_analytics', array($this, 'export_analytics'));
            add_action('wp_ajax_choya_get_analytics_data', array($this, 'get_analytics_data'));
        }
    }
    
    public function generate_analytics_report() {
        // Generate daily analytics summary
        global $wpdb;
        
        $analytics_table = $wpdb->prefix . 'choya_ai_analytics';
        $conversations_table = $wpdb->prefix . 'choya_ai_conversations';
        
        $yesterday = date('Y-m-d', strtotime('-1 day'));
        
        // Get daily stats
        $conversations = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT session_id) FROM $conversations_table WHERE DATE(timestamp) = %s",
            $yesterday
        ));
        
        $messages = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM $conversations_table WHERE DATE(timestamp) = %s",
            $yesterday
        ));
        
        $unique_users = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT user_id) FROM $conversations_table WHERE DATE(timestamp) = %s AND user_id > 0",
            $yesterday
        ));
        
        // Save daily report
        $report_table = $wpdb->prefix . 'choya_ai_daily_reports';
        $charset_collate = $wpdb->get_charset_collate();
        
        $sql = "CREATE TABLE IF NOT EXISTS $report_table (
            id mediumint(9) NOT NULL AUTO_INCREMENT,
            date DATE NOT NULL,
            conversations int(11) DEFAULT 0,
            messages int(11) DEFAULT 0,
            unique_users int(11) DEFAULT 0,
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            UNIQUE KEY date_idx (date)
        ) $charset_collate;";
        
        require_once ABSPATH . 'wp-admin/includes/upgrade.php';
        dbDelta($sql);
        
        $wpdb->replace(
            $report_table,
            array(
                'date' => $yesterday,
                'conversations' => $conversations ?: 0,
                'messages' => $messages ?: 0,
                'unique_users' => $unique_users ?: 0
            ),
            array('%s', '%d', '%d', '%d')
        );
    }
    
    public function export_analytics() {
        check_ajax_referer('choya_admin_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_die('Unauthorized');
        }
        
        $format = sanitize_text_field($_GET['format'] ?? 'csv');
        $date_from = sanitize_text_field($_GET['date_from'] ?? '');
        $date_to = sanitize_text_field($_GET['date_to'] ?? '');
        
        if (empty($date_from) || empty($date_to)) {
            wp_die('Please specify date range');
        }
        
        $data = $this->get_analytics_export_data($date_from, $date_to);
        
        if ($format === 'csv') {
            $this->export_csv($data);
        } elseif ($format === 'json') {
            $this->export_json($data);
        }
    }
    
    private function get_analytics_export_data($date_from, $date_to) {
        global $wpdb;
        
        $conversations_table = $wpdb->prefix . 'choya_ai_conversations';
        $analytics_table = $wpdb->prefix . 'choya_ai_analytics';
        
        $data = array(
            'conversations' => array(),
            'analytics' => array(),
            'summary' => array()
        );
        
        // Get conversations
        $conversations = $wpdb->get_results($wpdb->prepare(
            "SELECT * FROM $conversations_table WHERE DATE(timestamp) BETWEEN %s AND %s ORDER BY timestamp DESC",
            $date_from, $date_to
        ));
        
        $data['conversations'] = $conversations;
        
        // Get analytics events
        $analytics = $wpdb->get_results($wpdb->prepare(
            "SELECT * FROM $analytics_table WHERE DATE(timestamp) BETWEEN %s AND %s ORDER BY timestamp DESC",
            $date_from, $date_to
        ));
        
        $data['analytics'] = $analytics;
        
        // Get summary stats
        $summary = array(
            'total_conversations' => count(array_unique(array_column($conversations, 'session_id'))),
            'total_messages' => count($conversations),
            'total_events' => count($analytics),
            'unique_users' => count(array_unique(array_column($conversations, 'user_id'))),
            'date_range' => "$date_from to $date_to"
        );
        
        $data['summary'] = $summary;
        
        return $data;
    }
    
    private function export_csv($data) {
        header('Content-Type: text/csv');
        header('Content-Disposition: attachment; filename="choya-ai-analytics-' . date('Y-m-d') . '.csv"');
        
        $output = fopen('php://output', 'w');
        
        // Export summary
        fputcsv($output, array('Summary Statistics'));
        fputcsv($output, array('Total Conversations', $data['summary']['total_conversations']));
        fputcsv($output, array('Total Messages', $data['summary']['total_messages']));
        fputcsv($output, array('Total Events', $data['summary']['total_events']));
        fputcsv($output, array('Unique Users', $data['summary']['unique_users']));
        fputcsv($output, array('Date Range', $data['summary']['date_range']));
        
        fputcsv($output, array()); // Empty row
        
        // Export conversations
        fputcsv($output, array('Conversations'));
        fputcsv($output, array('ID', 'User ID', 'Session ID', 'Message', 'Sender', 'Timestamp'));
        
        foreach ($data['conversations'] as $conversation) {
            fputcsv($output, array(
                $conversation->id,
                $conversation->user_id,
                $conversation->session_id,
                $conversation->message,
                $conversation->sender,
                $conversation->timestamp
            ));
        }
        
        fclose($output);
        exit;
    }
    
    private function export_json($data) {
        header('Content-Type: application/json');
        header('Content-Disposition: attachment; filename="choya-ai-analytics-' . date('Y-m-d') . '.json"');
        
        echo json_encode($data, JSON_PRETTY_PRINT);
        exit;
    }
    
    public function get_analytics_data() {
        check_ajax_referer('choya_admin_nonce', 'nonce');
        
        if (!current_user_can('manage_options')) {
            wp_send_json_error(array('message' => 'Unauthorized'));
        }
        
        $range = sanitize_text_field($_POST['range'] ?? '7days');
        
        $data = $this->calculate_analytics($range);
        
        wp_send_json_success($data);
    }
    
    private function calculate_analytics($range) {
        global $wpdb;
        
        $conversations_table = $wpdb->prefix . 'choya_ai_conversations';
        $analytics_table = $wpdb->prefix . 'choya_ai_analytics';
        
        // Calculate date range
        $days = 7; // default
        if ($range === '30days') $days = 30;
        elseif ($range === '90days') $days = 90;
        
        $start_date = date('Y-m-d', strtotime("-$days days"));
        
        // Basic metrics
        $total_conversations = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT session_id) FROM $conversations_table WHERE DATE(timestamp) >= %s",
            $start_date
        ));
        
        $total_messages = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM $conversations_table WHERE DATE(timestamp) >= %s",
            $start_date
        ));
        
        $total_users = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT user_id) FROM $conversations_table WHERE DATE(timestamp) >= %s AND user_id > 0",
            $start_date
        ));
        
        // Daily breakdown
        $daily_stats = $wpdb->get_results($wpdb->prepare(
            "SELECT DATE(timestamp) as date, 
                    COUNT(DISTINCT session_id) as conversations,
                    COUNT(*) as messages,
                    COUNT(DISTINCT user_id) as users
             FROM $conversations_table 
             WHERE DATE(timestamp) >= %s 
             GROUP BY DATE(timestamp) 
             ORDER BY date DESC",
            $start_date
        ));
        
        // Top events (if analytics table exists)
        $top_events = array();
        if ($wpdb->get_var("SHOW TABLES LIKE '$analytics_table'") === $analytics_table) {
            $top_events = $wpdb->get_results($wpdb->prepare(
                "SELECT event_type, COUNT(*) as count
                 FROM $analytics_table 
                 WHERE DATE(timestamp) >= %s 
                 GROUP BY event_type 
                 ORDER BY count DESC 
                 LIMIT 10",
                $start_date
            ));
        }
        
        return array(
            'period' => $range,
            'total_conversations' => $total_conversations ?: 0,
            'total_messages' => $total_messages ?: 0,
            'total_users' => $total_users ?: 0,
            'avg_conversations_per_day' => $total_conversations ? round($total_conversations / $days) : 0,
            'daily_stats' => $daily_stats,
            'top_events' => $top_events
        );
    }
}